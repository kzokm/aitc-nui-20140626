<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bone Hands</title>
<!--
  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="http://js.leapmotion.com/leap-0.6.0.min.js"></script>
-->
  <script src="vendor/js/jquery-2.1.1.min.js"></script>
  <script src="vendor/js/leap-0.6.0.min.js"></script>
  <link rel="stylesheet" href="css/canvas.css">
</head>
<body>
  <h1>Bone Hands</h1>
  <p>Show the all bone positions.</p>

  <div class="controls">
    視点方向
    <select name="viewmode">
      <option value="xy">手前(Z to X-Y)</option>
      <option value="xz">真上(Y to X-Z)</option>
    </select>
  </div>

  <div id="content">
    <canvas></canvas>
  </div>
  <div id="dump"></div>

  <script>
$(function() {
  var $dump = $('#dump');

  var BONE_COLOR = [ '#ff3', '#3f3', '#3ff', '#f33' ];
  var JOINT_COLOR = [ '#888', '#ff8', '#8f8', '#8ff', '#f88' ];
  var TIP_COLOR = '#000';
  var PALM_COLOR = '#000';

  Leap.loop(function(frame) {
    if (frame.hands.length > 0) {
      console.log(frame);
    }
    canvas.clear();

    frame.hands.forEach(function(hand) {
      hand.fingers.forEach(function(finger) {
        finger.bones.forEach(function(bone, i) {
          canvas.drawBone(canvas.leapToScene(frame, bone.prevJoint),
                          canvas.leapToScene(frame, bone.nextJoint),
                          BONE_COLOR[i]);
        });

        // APIドキュメントにはbtipPositionの記述があるが、未定義なのでdistal.nextJointを用いる。
        canvas.drawJoint(canvas.leapToScene(frame, finger.distal.nextJoint), JOINT_COLOR[4]);
        canvas.drawJoint(canvas.leapToScene(frame, finger.dipPosition), JOINT_COLOR[3]);
        canvas.drawJoint(canvas.leapToScene(frame, finger.pipPosition), JOINT_COLOR[2]);
        canvas.drawJoint(canvas.leapToScene(frame, finger.mcpPosition), JOINT_COLOR[1]);
        canvas.drawJoint(canvas.leapToScene(frame, finger.carpPosition), JOINT_COLOR[0]);

        canvas.drawTip(canvas.leapToScene(frame, finger.tipPosition), TIP_COLOR);
      });

      canvas.drawPalm(canvas.leapToScene(frame, hand.palmPosition), PALM_COLOR);
    });

    $dump.html(frame.dump());
  });

  var Canvas = function(element) {
    this.element = element;
    this.context = element.getContext('2d');
  };

  Canvas.prototype = {
    width: 0, height: 0,
    iBoxArea: {},

    resize: function(width, height) {
      this.element.width = this.width = width;
      this.element.height = this.height = height;

      var marginLeft = width * 0.3;
      var marginTop = height * 0.25;
      this.iBoxArea = {
        left: marginLeft,
        top: marginTop,
        width: width - marginLeft * 2,
        height: height - marginTop * 2
      };
      this.clear();
    },

    clear: function() {
      this.context.clearRect(0, 0, this.width, this.height);
      this.drawIBoxArea();
    },

    drawIBoxArea: function() {
      var box = this.iBoxArea;
      var c = this.context;
      c.strokeStyle = 'black';
      c.lineWidth = 1;
      c.strokeRect(box.left, box.top, box.width, box.height);
    },

    drawBone: function(from, to, color) {
      var c = this.context;
      c.strokeStyle = color;
      c.lineWidth = 5;
      c.beginPath();
      c.moveTo(from.x, from.y)
      c.lineTo(to.x, to.y)
      c.closePath();
      c.stroke();
    },

    drawJoint: function(position, color) {
      this.drawCircle(position, position.radius, color);
    },

    drawTip: function(position, color) {
      this.drawCircle(position, position.radius / 2, color);
    },

    drawPalm: function(position, color) {
      this.drawCircle(position, position.radius * 2, color);
    },

    drawCircle: function(center, radius, color) {
      var c = this.context;
      c.strokeStyle = color;
      c.lineWidth = 3;
      c.beginPath();
      c.arc(center.x, center.y, radius, 0, Math.PI * 2);
      c.closePath();
      c.stroke();
    },

    leapToScene: function(frame, vec3) {
      vec3 = frame.interactionBox.normalizePoint(vec3);

      var box = this.iBoxArea;
      var pos = {
        x: vec3[X] * box.width + box.left,
        y: vec3[Y] * box.height + box.top
      };

      if (Y != 2) {
        pos.y = this.height - pos.y;
      }

      var radius;
      if (Z == 1) {
        radius = 1.0 - vec3[Z];
      }
      else {
        radius = 1.0 - Math.abs(0.5 - vec3[Z]);
      }
      radius = Math.sqrt(radius) * Math.min(box.width, box.height) / 16.0 || 0;
      pos.radius = Math.max(radius, 10.0);

      for (i = 0; i < 3; i++) {
        if (vec3[i] < 0.0 || vec3[i] > 1.0) {
          pos.inbounds = false;
          break;
        }
      }
      pos.inbounds = (pos.inbounds === undefined);

      return pos;
    }
  };

  var canvas = new Canvas($('canvas')[0]);
  $(window).resize(function() {
    var margin = $('#content').position();
    var width = window.innerWidth - margin.left * 2;
    var height = window.innerHeight - margin.top - margin.left * 2;
    canvas.resize(width, height);
  }).resize();

  var X = 0, Y = 1, Z = 2;
  $(':input[name="viewmode"]').change(function() {
    switch ($(this).val()) {
      case 'xy':
        X = 0;
        Y = 1;
        Z = 2;
        break;
      case 'xz':
        X = 0;
        Y = 2;
        Z = 1;
        break;
    }
  }).change();
});
  </script>
</body>
</html>
