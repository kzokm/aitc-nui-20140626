<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Parm and Finger Positions</title>
<!--
  <script src="http://js.leapmotion.com/leap-0.4.3.min.js"></script>
  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
-->
  <script src="vendor/js/leap-0.4.3.min.js"></script>
  <script src="vendor/js/jquery-2.1.1.min.js"></script>
  <link rel="stylesheet" href="css/canvas.css">
</head>
<body>
  <h1>Parm and Finger Positions</h1>
  <p>Show the all finger positions.</p>

  <div class="controls">
    視点方向
    <select name="viewmode">
      <option value="xy">手前(Z to X-Y)</option>
      <option value="xz">真上(Y to X-Z)</option>
    </select>
  </div>

  <div id="content">
    <canvas></canvas>
  </div>
  <div id="dump"></div>

  <script>
$(function() {
  var $dump = $('#dump');

  Leap.loop(function(frame) {
    if (frame.hands.length > 0) {
      console.log(frame);
    }
    canvas.clear();

    frame.hands.forEach(function(hand) {
      var palmPosition = canvas.leapToScene(frame, hand.palmPosition);
      hand.fingers.forEach(function(finger) {
        canvas.drawFinger(palmPosition,
                          canvas.leapToScene(frame, finger.tipPosition));
      });
      canvas.drawPalm(palmPosition);
    });

    $dump.html(frame.dump());
  });

  var Canvas = function(element) {
    this.element = element;
    this.context = element.getContext('2d');
  };

  Canvas.prototype = {
    width: 0, height: 0,
    iBoxArea: {},

    resize: function(width, height) {
      this.element.width = this.width = width;
      this.element.height = this.height = height;

      var marginLeft = width * 0.3;
      var marginTop = height * 0.25;
      this.iBoxArea = {
        left: marginLeft,
        top: marginTop,
        width: width - marginLeft * 2,
        height: height - marginTop * 2
      };
      this.clear();
    },

    clear: function() {
      this.context.clearRect(0, 0, this.width, this.height);
      this.drawIBoxArea();
    },

    drawIBoxArea: function() {
      var box = this.iBoxArea;
      var c = this.context;
      c.strokeStyle = 'black';
      c.lineWidth = 1;
      c.strokeRect(box.left, box.top, box.width, box.height);
    },

    drawPalm: function(palm) {
      var c = this.context;
      c.fillStyle = palm.inbounds ? 'green' : 'red';
      c.beginPath();
      c.arc(palm.x, palm.y, palm.radius * 2, 0, Math.PI * 2);
      c.closePath();
      c.fill();
    },

    drawFinger: function(palm, tip) {
      var c = this.context;

      // draw finger line
      c.strokeStyle = 'darkgray';
      c.lineWidth = 3;
      c.beginPath();
      c.moveTo(palm.x, palm.y)
      c.lineTo(tip.x, tip.y)
      c.closePath();
      c.stroke();

      // draw tip circle
      c.strokeStyle = tip.inbounds ? 'green' : 'red';
      c.beginPath();
      c.arc(tip.x, tip.y, tip.radius, 0, Math.PI * 2);
      c.closePath();
      c.stroke();
    },

    leapToScene: function(frame, vec3) {
      vec3 = frame.interactionBox.normalizePoint(vec3);

      var box = this.iBoxArea;
      var pos = {
        x: vec3[X] * box.width + box.left,
        y: vec3[Y] * box.height + box.top
      };

      if (Y != 2) {
        pos.y = this.height - pos.y;
      }

      var radius;
      if (Z == 1) {
        radius = 1.0 - vec3[Z];
      }
      else {
        radius = 1.0 - Math.abs(0.5 - vec3[Z]);
      }
      radius = Math.sqrt(radius) * Math.min(box.width, box.height) / 16.0 || 0;
      pos.radius = Math.max(radius, 10.0);

      for (i = 0; i < 3; i++) {
        if (vec3[i] < 0.0 || vec3[i] > 1.0) {
          pos.inbounds = false;
          break;
        }
      }
      pos.inbounds = (pos.inbounds === undefined);

      return pos;
    }
  };

  var canvas = new Canvas($('canvas')[0]);
  $(window).resize(function() {
    var margin = $('#content').position();
    var width = window.innerWidth - margin.left * 2;
    var height = window.innerHeight - margin.top - margin.left * 2;
    canvas.resize(width, height);
  }).resize();

  var X, Y, Z;
  $(':input[name="viewmode"]').change(function() {
    switch ($(this).val()) {
      case 'xy':
        X = 0; Y = 1; Z = 2;
        break;
      case 'xz':
        X = 0; Y = 2; Z = 1;
        break;
    }
  }).change();
});
  </script>
</body>
</html>
